{% extends 'layout.html' %}
{% load tags %}
{% load frontend_tags %}
{% load static %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/libraries.css' %}">
<style>
	td > .select2-container--default .select2-selection--single {
		border: none;
	}

	td .select2-selection__rendered {
		text-align: left;
	}
</style>
{% endblock %}
{% block content %}
<div class="container-fluid">
	<div class="row px-3 pt-3">
		<div class="col-lg-8">
			<h1 class="font-weight-bold">Directory List</h1>
			<ol class="breadcrumb bg-transparent p-0">
				<li class="breadcrumb-item">
					<a href="{% url 'backend-dashboard' %}">Home</a>
				</li>
				<li class="breadcrumb-item active">
					<strong>Directory List</strong>
				</li>
			</ol>
		</div>
		<div class="col-lg-4 pt-3">
			<div class="float-md-right">
				{% if user|check_permission:'directory_management' or user|check_permission:'superadmin' %}
					<a class="btn btn-info" data-toggle="modal" data-target="#register" onclick="$('#action').val('0'); $('.tbltypeanddetails tbody').empty(); $('.add').click();"><i class="fas fa-plus"></i> New Contact</a>
				{% endif %}
			</div>
		</div>
	</div>
</div>
<div class="content-wrapper p-5 ml-0">
	<div class="row">
		<div class="col-sm-9">
			<div class="card card-info card-outline">
				<div class="card-body">
					<table id="directory-table" class="table table-bordered" width="100%">
						<thead>
							<tr>
								{% if user|check_permission:'directory_management' or user|check_permission:'superadmin' %}
								<th>ACTION</th>
								{% endif %}
								<th>CONTACT NAME</th>
								<th>COMPANY / ORGANIZATION</th>
								<th>POSITION / JOB TITLE</th>
								<th>ADDRESS</th>
								<th>EMAIL</th>
								<th>PHONE</th>
								<th>LAST UPDATED BY</th>
								<th>LAST UPDATED ON</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="card">
				<div class="card-header bg-info">
					<h5 class="card-title font-weight-bold">FILTER</h5>
				</div>
				<div class="card-body">
					<h4>By organization type</h4>
					<div class="list-group">
						<a class="list-group-item list-group-item-action active"  id="status-all" href="javascript:;" data-role="status" data-filter="all">All</a>
						{% for row in orgtype %}
						<a class="list-group-item list-group-item-action" id="status-{{ row.id }}" href="javascript:;" data-role="status" data-filter="{{ row.id }}">{{ row.acronym }}</a>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% if user|check_permission:'directory_management' or user|check_permission:'superadmin' %}
	<div class="modal" id="register" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInDown">
				<div class="modal-header bg-info">
					<h3 class="modal-title">
						NEW CONTACT
						<p><small>Accurately provide required details for new contact.</small></p>
					</h3>
					<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				</div>
				<form id="submitContactForm">
				{% csrf_token %}
				<input type="hidden" name="action" id="action" value="">
				<input type="hidden" name="id" id="id" value="">
				<div class="modal-body">
					<div id="alertDiv"></div>
					<div class="row">
						<div class="col-sm-6">
							<div class="form-group">
								<label>Last Name<span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="last_name" name="last_name" required>
							</div>
						</div>
						<div class="col-sm-6">
							<div class="form-group">
								<label>First Name<span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="first_name" name="first_name" required>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4">
							<div class="form-group">
								<label>Middle Name</label>
								<input type="text" class="form-control" id="middle_name" name="middle_name">
							</div>
						</div>
						<div class="col-sm-3">
							<div class="form-group">
								<label>Name Ext.</label>
								<select class="form-control select" name="ext" id="ext">
									<option></option>
									{% for row in ext %}
									<option value="{{ row.id }}">{{ row.name }}</option>
									{% endfor %}
								</select>
							</div>
						</div>
						<div class="col-sm-5">
							<div class="form-group">
								<label>Position / Job Title<span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="job_title" name="job_title" required>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-8">
							<div class="form-group">
								<label>Company / Organization<span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="company" name="company" required>
							</div>
						</div>
						<div class="col-sm-4">
							<div class="form-group">
								<label>Org Type<span class="text-danger">*</span></label>
								<select class="form-control select" name="orgtype" id="orgtype" required>
									<option></option>
									{% for row in orgtype %}
									<option value="{{ row.id }}">{{ row.acronym }}</option>
									{% endfor %}
								</select>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<div class="form-group">
								<label>Additional Details / Notes</label>
								<textarea class="form-control" name="notes" id="notes" style="resize:vertical; min-height:50px;"></textarea>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12" id="parentDiv">
							<table class="table table-bordered tbltypeanddetails">
								<thead style="font-size: 13px;">
									<tr>
										<th style="width:40%; text-transform:capitalize !important;" class="center nopadding">Type<span class="text-danger">*</span></th>
										<th style="width:57%; text-transform:capitalize !important;" class="center nopadding">Description<span class="text-danger">*</span></th>
										<th style="width:3%;" class="center"><button type="button" class="btn btn-info btn-xs add"><i class="fas fa-plus"></i></button></th>
									</tr>
								</thead>
								<tbody>
									<tr class="fieldwrapper">
										<td class="nopadding">
											<select class="form-control select input-sm dl" name="dtype[]" style="border:none;" required>
												<option></option>
												{% for row in detail_types %}
												<option value="{{ row.id }}">{{ row.type }}</option>
												{% endfor %}
											</select>
										</td>
										<td class="nopadding"><input type="text" name="description[]" class="form-control" style="border:none; font-size:11px;" required></td>
										<td class="nopadding" style="text-align:center !important;">
											<button type="button" class="btn btn-danger btn-xs" data-role="remove"><i class="fa fa-minus"></i></button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-info">Save changes</button>
				</div>
				</form>
			</div>
		</div>
	</div>
	<div class="modal" id="edit" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInDown">
				<div class="modal-header bg-info">
					<h3 class="modal-title">
						EDIT CONTACT
						<p><small>Accurately provide required details for new contact.</small></p>
					</h3>
					<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				</div>
				<div class="modal-body"></div>
			</div>
		</div>
	</div>
{% endif %}
{% endblock %}
{% block script %}
<script type="text/javascript">
	$(document).ready(function(){
		$(document).on('click', 'a[data-role=status]', function(){
        	$('.list-group-item').removeClass('active');
        	$('#status-'+$(this).data('filter')).addClass('active');

			if($(this).data('filter') == 'all'){
				$('#directory-table').DataTable().ajax.url('/api/directory/list/?format=datatables').load();
			}else{
				$('#directory-table').DataTable().ajax.url('/api/directory/list/?format=datatables&orgtype_id='+ $(this).data('filter')).load();
        	}
        });

		DirectoryTable();

		function DirectoryTable(){
			$('#directory-table').DataTable({
				'serverSide': true,
				'processing': true,
				'deferRender': true,
				'lengthMenu': [ 10, 25, 50, 100 ],
				'order': [[ 1, 'asc' ]],
				'ajax': {
					'url': '/api/directory/list/?format=datatables',
					'type': 'GET',
					'beforeSend': function (request) {
						request.setRequestHeader("Authorization", "Token 82b88a7bdac1ea3868361448927035e93b0dc19d")
					}
				},
				'fnCreatedRow': function (row, data, index) {
					$(row).attr('id', data['id']);
				},
				'columns': [
					{% if user|check_permission:'directory_management' or user|check_permission:'superadmin' %}{'data': 'id','render': function(data, type, row, meta) {return "<a href='javascript:;' data-role='edit' data-id='"+ data +"'>Edit</a>"}},{% endif %}
					{'data': 'contact_name', 'name': 'last_name, first_name, middle_name'},
					{'data': 'company' },
					{'data': 'job_title' },
					{'data': 'address', 'searchable': 'false' },
					{'data': 'email', 'searchable': 'false' },
					{'data': 'contact', 'searchable': 'false' },
					{'data': 'last_updated_by', 'name': 'last_updated_by.first_name, last_updated_by.middle_name, last_updated_by.last_name'},
					{'data': 'last_updated_on' }
				],
			});
		}

		{% if user|check_permission:'directory_management' or user|check_permission:'superadmin' %}
		$(document).on('click', 'a[data-role=edit]', function() {
			var id = $(this).data('id');
			$('#edit').find('.modal-body').empty();
			$('#edit').find('.modal-body').load('/directory/list/edit/' + id);
			$('#edit').modal('show');
		});

		var max = 7;
		var x = 1;
		var fieldHTML= '<tr class="fieldwrapper">\
							<td class="nopadding">\
								<select class="form-control select input-sm dl" name="dtype[]" style="border:none;" required>\
									<option></option>'+
									{% for row in detail_types %}
									'<option value="{{ row.id }}">{{ row.type }}</option>'+
									{% endfor %}
								'</select>\
							</td>\
							<td class="nopadding">\
								<input type="text" name="description[]" class="form-control" style="border:none; font-size:11px;" required>\
							</td>\
							<td class="nopadding" style="text-align:center !important;">\
								<button type="button" class="btn btn-danger btn-xs" data-role="remove">\
									<i class="fa fa-minus"></i>\
								</button>\
							</td>\
						</tr>';

		$('.add').on('click', function(){
			$('.tbltypeanddetails > tbody:last-child').append(fieldHTML);
			$('.dl').select2({
				allowClear: true,
				width: '100%',
				placeholder: 'Choose'
			});
		});

		$(document).on('click','button[data-role="remove"]', function(e){
			e.preventDefault();
			if($(".tbltypeanddetails > tbody > tr").length > 1) {
				$('table tr:last').remove();
			}
		});

		$('#submitContactForm').on('submit', function(e){
			var form = new FormData(this);
			Swal.fire({
				title: "Are you sure",
				text: "You want to save this new contact?",
				icon: "info",
				showCancelButton: true,
				confirmButtonColor: "#3498DB",
				confirmButtonText: "Yes",
				 allowOutsideClick: false,
			}).then((result) => {
				if (result.isConfirmed) {
					$.ajax({
						data        : form,
						url         : '{% url "directory-list-requests" %}',
						type        : 'POST',
						cache       : false,
						contentType : false,
						processData : false
					})
					.done(function(data){
						if (data.data == "success"){
							Swal.fire({
								title: "Good job!",
								text: "New contact was added successfully.",
								icon: "success",
								confirmButtonColor: "#3498DB",
							}).then((result) => {
								if (result.isConfirmed) {
									$('#submitContactForm').trigger('reset');
									$('#register').modal('hide');
									$('#directory-table').DataTable().ajax.reload();
								}
							});
						} else {
							$('#alertDiv').empty();
							$('#alertDiv').append('<p class="text-danger"><strong>* ' + data.error + '<strong></p>');
						}
					});
				}
			});
			e.preventDefault();
		});
		{% endif %}
	});
</script>
{% endblock %}