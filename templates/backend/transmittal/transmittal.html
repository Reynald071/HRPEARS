{% extends 'layout.html' %}
{% load static %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
{% endblock %}
{% block content %}
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-8">
        <h1 class="bold">Transmittal</h1>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'backend-dashboard' %}">Home</a>
            </li>
            <li class="breadcrumb-item active">
                Transmittal Management
            </li>
        </ol>
    </div>
    <div class="col-lg-4">
        <div class="title-action">
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#show-summary">
                <i class="fas fa-chart-bar"></i> Show Summary
            </button>
        </div>
    </div>
</div>
<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <div class="alert alert-info">
                        <p class="bold"><i class="fas fa-info-circle"></i> INCOMING AND OUTGOING REGISTRATION</p>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="tabs-container">
                        <ul class="nav nav-tabs" id="tabUL">
                            <li class="active"><a class="nav-link" data-toggle="tab" href="#registration-view">Registration</a></li>
                            <li><a class="nav-link" data-toggle="tab" href="#transmittal-workflow">Workflow</a></li>
                        </ul>
                        <div class="tab-content" style="border: 0px !important;">
							<div id="registration-view" class="tab-pane active">
                                <div class="panel-body">
                                    <form id="submitForm">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="form-group">
                                                <label>Status<span class="asteriskField">*</span></label>
                                                <select class="form-control select" name="status" id="status" required>
                                                    <option></option>
                                                    <option value="0">Incoming</option>
                                                    <option value="1">Outgoing</option>
                                                    <option value="2">Approved</option>
                                                    <option value="3">Disapproved</option>
                                                    <option value="4">For Return</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="form-group">
                                                <label>Date Received<span class="asteriskField">*</span></label>
                                                <input type="date" class="form-control" name="date_received" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Document Date<span class="asteriskField">*</span></label>
                                        <input type="date" class="form-control" name="date_document" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Document Type<span class="asteriskField">*</span></label>
                                        <select class="form-control select" name="document_type" required>
                                            <option></option>
                                            {% for row in type %}
                                            <option value="{{ row.id }}">{{ row.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group" id="forward_to_content" style="display:none;">
                                        <label>Forward To<span class="asteriskField">*</span></label>
                                        <select class="form-control select" name="forward_to" id="forward_to">
                                            <option></option>
                                            {% for row in division %}
                                            <option value="{{ row.id }}">{{ row.div_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Other Document Information</label>
                                        <textarea class="form-control" name="other_info" rows="3"></textarea>
                                    </div>
                                    <br>
                                    <button type="submit" class="btn btn-info">Submit</button>
                                    <button type="button" class="btn btn-default" id="clear-btn">Clear</button>
                                    </form>
                                </div>
                            </div>
                            <div id="transmittal-workflow" class="tab-pane">
                                <div class="panel-body table-responsive">
                                    <table class="table table-bordered table-hover" id="workflow-table" width="100%">
                                        <thead>
                                            <th class="display-none">Tracking No</th>
                                            <th>Action</th>
                                            <th>Status</th>
                                            <th>Document Owner</th>
                                            <th>Document Name</th>
                                            <th>Details</th>
                                            <th>Document Date</th>
                                            <th>Date Received / Forwarded</th>
                                            <th>Registered by</th>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="row">
                <div class="col-lg-4">
                    <div class="ibox">
                        <div class="ibox-title bg-primary">
                            <h3 class="no-margins">SEARCH EMPLOYEE</h3>
                            <small>Please fill in the search form below to add the employee</small>
                        </div>
                        <div class="ibox-content">
                            <form id="addEmployeeForm">
                            {% csrf_token %}
                            <div class="form-group">
                                <label>Search Employee<span class="asteriskField">*</span></label>
                                <input type="text" class="form-control filter-transmittal-employee" name="employee_name" autocomplete="off" required>
                            </div>
                            <br>
                            <button type="submit" class="btn btn-info">Add Employee</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="ibox">
                        <div class="ibox-content">
                            <div id="employee-add-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="view-transmittal-modal" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog modal-lg">
		<div class="modal-content animated bounceInDown" style="padding-bottom: 0px !important;">
            <div class="modal-header">
                <button type="button" class="close text-white" data-dismiss="modal" style="color: #1b2a33 !important; opacity: 1;"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title"><strong>VIEW TRANSMITTAL</strong></h3>
            </div>
            <div class="content"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    $('#clear-btn').on('click', function(){
        $('#submitForm').trigger('reset');
        $('.select').val('').change();
    });

    $(".filter-transmittal-employee").typeahead({
        source: function(query, process){
            return $.get({
                url: '{% url "filter_employee_all" %}',
                data: { query: query },
                datatype: 'json',
                success: function (data) {
                    return process(data);
                }
            });
        },
        highlight: true,
    });

    $('#status').on('change', function(){
        if($(this).val() == 1){
            $('#forward_to_content').css('display', '');
            $('#forward_to').attr('required', 'required');
        }else{
            $('#forward_to_content').css('display', 'none');
            $('#forward_to').removeAttr('required');
        }
    });

    $(':checkbox[name=selectAll]').click (function () {
        $('.checkbox').prop('checked', this.checked);
    });

    $('#workflow-table').DataTable({
        'serverSide': true,
        'processing': true,
        'deferRender': true,
        'order': [[ 1, 'desc' ]],
        'lengthMenu': [25,50,100],
        'ajax': {
            'url': '/api/transmittal/?format=datatables',
            'type': 'GET',
        },
        'fnCreatedRow': function (row, data, index) {
            $(row).attr('id', data['id']);
        },
        'columns': [
            {'data': 'tracking_no', 'className': 'display-none' },
            {'data': 'id',
                'render': function(data, type, row, meta){
                    var template = '<a href="javascript:;" data-role="view" data-id="'+ data +'">Details</a>';
                    template += ' | <a href="javascript:;" data-role="delete" data-id="'+ data +'">Delete</a>';
                    return template;
                }
            },
            {'data': 'status',
                'render': function(data, type, row, meta){
                    if(data == 0) {
                        return '<span class="label label-default">Incoming</span>';
                    }else if(data == 1) {
                        return '<span class="label label-primary">Outgoing</span>';
                    }else if(data == 2) {
                        return '<span class="label label-success">Approved</span>';
                    }else if(data == 3) {
                        return '<span class="label label-danger">Disapproved</span>';
                    }else if(data == 4) {
                        return '<span class="label label-warning">For Return</span>';
                    }
                },
                'className': 'text-center',
                'searchable': false
            },
            {'data': 'owner', 'name': 'emp.pi.user.last_name, emp.pi.user.first_name' },
            {'data': 'document_name', 'name': 'document_name.name' },
            {'data': 'details' },
            {'data': 'document_date', 'className': 'text-center' },
            {'data': 'date', 'className': 'text-center', 'searchable': false },
            {'data': 'registered_by', 'className': 'text-center', 'searchable': false},
        ],
    });

    $(document).on('click', 'a[data-role=delete]', function(){
        var id = $(this).data('id');
        Swal.fire({
		    title: "Are you sure?",
		    text: "You want to delete this document",
		    icon: "info",
		    showCancelButton: true,
		    confirmButtonText: "Yes",
		    confirmButtonColor: "#3498DB",
		    allowOutsideClick: false,
		    showLoaderOnConfirm: true,
		    preConfirm: function (){
                return $.ajax({
                    data        : {
                        'id': id,
                    },
                    url         : '{% url "delete_transmittal" %}',
                    type        : 'POST',
                });
		    },
		}).then(function (data){
		    if (data.value.data == "success"){
                Swal.fire({
                    title: "Good job!",
                    html: "You have deleted the document.",
                    icon: "success",
                    confirmButtonColor: "#3498DB",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed){
                        $('#workflow-table').DataTable().ajax.reload();
                    }
                });
            } else {
                Swal.fire({
                    title: "Ooops!",
                    html: data.value.msg,
                    icon: "warning",
                })
            }
		});
    });

    $(document).on('click', 'a[data-role=view]', function(){
        $('.content').load('/backend/transmittal/view/details/' + $(this).data('id'), function() {
            $('#view-transmittal-modal').modal('show');
        });
    });

    $('#addEmployeeForm').on('submit', function(e){
        var form = new FormData(this);
        $.ajax({
            data        : form,
            url         : '{% url "add_employee_transmittal" 0 %}',
            type        : 'POST',
            success: function(response){
                $('#employee-add-content').append(
                    `
                    <div id="content-`+ response.pk +`">
                    <div class="row">
                        <div class="col-lg-1">
                            <center>
                                <button type="button" class="btn btn-danger" data-role="remove-employee" data-id="`+ response.pk +`">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </center>
                        </div>
                        <div class="col-lg-11">
                            <input type="hidden" class="checkbox" value="`+ response.id +`" checked>
                            <p class="no-margins"><strong>`+ response.full_name + `</strong></p>
                            <small>` + response.position + `</small>
                        </div>
                    </div>
                    <hr>
                    </div>
                    `
                );
                $('#addEmployeeForm').trigger('reset');
            },
            cache       : false,
            contentType : false,
            processData : false,
        })
        e.preventDefault();
    });

    $(document).on('click', 'button[data-role=remove-employee]', function(){
        var id = $(this).data('id');
        $('#content-'+ id).remove();
    });

    $('#submitForm').on('submit', function(e){
    	var data = [];
    	$('.checkbox').each(function(){
            if ($(this).prop('checked') == true){
                data.push($(this).val());
            }
        });

        if (data.length === 0) {
            Swal.fire('Ooops!', 'No employee has been added to the field.', 'warning');
        } else {
            var form = new FormData(this);
            for (var i = 0; i < data.length; i++) {
                form.append('emp_id[]', data[i]);
            }

            Swal.fire({
                title: "Are you sure?",
                text: "You want to register this document",
                icon: "info",
                showCancelButton: true,
                confirmButtonText: "Yes",
                confirmButtonColor: "#3498DB",
                allowOutsideClick: false,
                showLoaderOnConfirm: true,
                preConfirm: function (){
                    return $.ajax({
                        data        : form,
                        url         : '{% url "transmittal" %}',
                        type        : 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                    });
                },
            }).then(function (data){
                if (data.value.data == "success"){
                    Swal.fire({
                        title: "Good job!",
                        html: "You have successfully registered the document.",
                        icon: "success",
                        confirmButtonColor: "#3498DB",
                        allowOutsideClick: false,
                    }).then((result) => {
                        if (result.isConfirmed){
                            $('#workflow-table').DataTable().ajax.reload();
                            $('#employee-add-content').empty();
                        }
                    });
                } else {
                    Swal.fire({
                        title: "Ooops!",
                        html: data.value.msg,
                        icon: "warning",
                    })
                }
            });
        }

        e.preventDefault();
    });
</script>
{% endblock %}