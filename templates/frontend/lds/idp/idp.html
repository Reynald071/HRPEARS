{% extends 'layout.html' %}
{% load static %}
{% load frontend_tags %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row px-3 pt-3">
        <div class="col-lg-8">
            <h1 class="font-weight-bold">Individual Development Plan</h1>
            <ol class="breadcrumb bg-transparent p-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'backend-dashboard' %}">Home</a>
                </li>
                <li class="breadcrumb-item active">
                    <a href="javascript:;">Learning and Development</a>
                </li>
                <li class="breadcrumb-item active">
                    <strong>Individual Development Plan</strong>
                </li>
            </ol>
        </div>
        <div class="col-lg-4 pt-3">
            <div class="float-md-right">
                <button class="btn btn-info" data-toggle="modal" data-target="#create_idp"><i class="fas fa-plus"></i> Create IDP</button>
            </div>
        </div>
    </div>
</div>
<div class="content-wrapper p-5 ml-0">
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-info card-outline">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="table-idp" width="100%">
                            <thead>
                                <th width="10%">Action</th>
                                <th>Year</th>
                                <th width="30%">Aim</th>
                                <th class="text-center">Date Created</th>
                                <th class="text-center">Date Updated</th>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="create_idp" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content animated bounceInDown">
	        <div class="modal-header bg-info">
	            <h3 class="modal-title">
                    CREATE INDIVIDUAL DEVELOPMENT PLAN

                </h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        </div>
            <form id="createIDPForm">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label>Year<span class="asteriskField">*</span></label>
                    <input type="number" class="form-control" min="1900" max="2099" value="{{ year }}" name="year" required>
                </div>
                <div class="form-group">
                    <label>Aim<span class="asteriskField">*</span></label>
                    <textarea class="form-control" rows="5" name="aim" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-info">Submit</button>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal" id="update_idp" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content animated bounceInDown">
	        <div class="modal-header bg-info">
	            <h3 class="modal-title">
                    EDIT INDIVIDUAL DEVELOPMENT PLAN

                </h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        </div>
            <div id="update-idp-details"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    $('#table-idp').DataTable({
        'serverSide': true,
        'processing': true,
        'deferRender': true,
        'order': [[ 1, 'desc' ]],
        'ajax': {
            'url': '/api/learning-and-development/idp/?format=datatables&emp_pk='+'{% getHash request.session.emp_id as employee_id %}{{ employee_id }}',
            'type': 'GET',
        },
        'fnCreatedRow': function (row, data, index) {
            $(row).attr('id', data['id']);
        },
        'columns': [
            {'data': 'id',
                'render': function (data, type, row, meta) {
                    var template = '<a href="javascript:;" data-role="details" data-id="'+ data +'">Details</a> ';
                    template += ' | <a href="javascript:;" data-role="duplicate" data-id="'+ data +'">Duplicate</a>';
                    return template
                }
            },
            {'data': 'year',
                'render': function (data, type, row, meta) {
                    var template = '<a href="javascript:;" data-role="update" data-id="'+ row['id'] +'">' + data + '</a> ';
                    return template;
                }
            },
            {'data': 'aim' },
            {'data': 'date_created', 'className': 'text-center' },
            {'data': 'date_updated', 'className': 'text-center' },
        ],
    });

    $('#createIDPForm').on('submit', function(e){
        var form = new FormData(this);
	    e.preventDefault();
		Swal.fire({
		    title: "Are you sure?",
		    text: "You want to create an Individual Development Plan",
		    icon: "info",
		    showCancelButton: true,
		    confirmButtonText: "Yes",
		    confirmButtonColor: "#3498DB",
		    allowOutsideClick: false,
		    showLoaderOnConfirm: true,
		    preConfirm: function (){
                return $.ajax({
                    data        : form,
                    url         : '{% url "idp" %}',
                    type        : 'POST',
                    cache       : false,
                    contentType : false,
                    processData : false,
                });
		    },
		}).then(function (response){
		    if (response.value.data == "success"){
                Swal.fire({
                    title: "Good job!",
                    html: response.value.msg,
                    icon: "success",
                    confirmButtonColor: "#3498DB",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed){
                        $('#createIDPForm').trigger('reset');
                        $('#table-idp').DataTable().ajax.reload();
                        $('#create_idp').modal('hide');
                    }
                });
            } else {
                Swal.fire('Ooops!', response.value.msg, 'warning');
            }
		});
        e.preventDefault();
    });

    $(document).on('click', 'a[data-role=update]', function(){
        var id = $(this).data('id');
        $('#update-idp-details').load('/learning-and-development/individual-development-plan/edit/' + id, function(){
            $('#update_idp').modal('show');
        });
    });

    $(document).on('click', 'a[data-role=details]', function(){
        var id = $(this).data('id');
        window.location.href = '/learning-and-development/individual-development-plan/update/' + id;
    });

    $(document).on('click', 'a[data-role=duplicate]', function(){
        var id = $(this).data('id');
        Swal.fire({
            title: "Are you sure?",
            text: "You want to duplicate this Individual Development Plan",
            icon: "info",
            showCancelButton: true,
            confirmButtonText: "Yes",
            confirmButtonColor: "#3498DB",
            allowOutsideClick: false,
            showLoaderOnConfirm: true,
            preConfirm: function (){
                return $.ajax({
                    url: '{% url "duplicate_idp_contents" %}',
                    data: {
                        pk: id
                    },
                    type: 'POST'
                });
            },
        }).then(function (response){
            if (response.value.data == "success"){
                Swal.fire({
                    title: "Good job!",
                    html: response.value.msg,
                    icon: "success",
                    confirmButtonColor: "#3498DB",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed){
                        $('#table-idp').DataTable().ajax.reload();
                    }
                });
            }
        });
    });
</script>
{% endblock %}