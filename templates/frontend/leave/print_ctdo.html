<!DOCTYPE html>
{% load static %}
{% load frontend_tags %}
{% load tags %}
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>DSWD My PORTAL | Print CTDO Requests</title>
	<link rel="shortcut icon" type="image/png" href="{% static 'image/logo.ico' %}"/>
	<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">
	<link href="{% static 'font-awesome/css/all.css' %}" rel="stylesheet">
    <link href="{% static 'css/print.css' %}" rel="stylesheet">
    <style>
        @media print {
			.containerX {
				padding: 0px;
				margin: 0px;
				height: 0% !important;
			}
			page {
				margin: 0px;
				border: 0.5px solid transparent;
				height: 204mm !important;
			}
        }

        .no-margins{
            margin: 0 !important;
        }
    </style>
</head>
<nav class="navbar navbar-default" style="font-family: 'Inter';">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<i class="fas fa-bars"></i>
			</button>
			<a class="navbar-brand" href="javascript:;">CTDO Requests ({{ data.tracking_no }})</a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav navbar-right">
				<li><a href="javascript:;" class="print-button" id="floatprint" title="Print" style="font-size: 14px;"><i class="fas fa-print"></i> Print</a></li>
			</ul>
		</div>
	</div>
</nav>
<body>
    <page size="A4" style="padding-right: 35px; padding-left: 35px; padding-top: 50px; position: relative; page-break-after: always; font-family: 'Inter';">
		<div class="containerX">
            <table width="100%">
                <tr>
                    <td class="text-center" width="50%">
                        <strong>Department of Social Welfare and Development</strong> <br> Field Office Caraga Region <br> Butuan City
                    </td>
                    <td class="text-center">
                        <strong>CERTIFICATION OF COC Earned</strong><br>
                        This is to certify that <strong><u>{{ data.emp.pi.user.first_name|upper }} {{ data.emp.pi.user.middle_name|to_middleinitial }} {{ data.emp.pi.user.last_name|upper }}</u></strong> has rendered
                        compensable OT services and has an unexpired compensatory overtime credits (COC) as of __________________ as follows:
                    </td>
                </tr>
                <tr>
                    <th class="text-center"><h4><strong>COMPENSATORY DAY OFF PERMIT</strong></h4></th>
                    <td class="text-center">
                        <br><br>
                        <table border="1" width="100%" id="table-ctdo">
                            <thead>
                                <th class="text-center">Particular</th>
                                <th class="text-center">Day(s)</th>
                                <th class="text-center">Hour(s)</th>
                                <th class="text-center">Minute(s)</th>
                            </thead>
                            <tbody>
                                {% if history %}
                                    <tr>
                                        <td>Available</td>
                                        <td>{% if history.total_days %}{{ history.total_days }}{% endif %}</td>
                                        <td>{% if history.total_hours %}{{ history.total_hours }}{% endif %}</td>
                                        <td>{% if history.total_minutes %}{{ history.total_minutes }}{% endif %}</td>
                                    </tr>
                                    <tr>
                                        <td>Applied</td>
                                        <td>{% if history.total_u_days %}{{ history.total_u_days }}{% endif %}</td>
                                        <td>{% if history.total_u_hours %}{{ history.total_u_hours }}{% endif %}</td>
                                        <td>{% if history.total_u_minutes %}{{ history.total_u_minutes }}{% endif %}</td>
                                    </tr>
                                    <tr>
                                        <td>Total Balance</td>
                                        <td><span id="total_b_days">{{ total_b_days }}</span></td>
                                        <td><span id="total_b_hours">{{ total_b_hours }}</span></td>
                                        <td><span id="total_b_minutes">{{ total_b_minutes }}</span></td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td>Available</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Applied</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Total Balance</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                {% endif %}
                            </tbody>
                            {% if data.remarks %}
                            <tfooter>
                                <td colspan="4">Note: {{ data.remarks }}</td>
                            </tfooter>
                            {% endif %}
                        </table>
                    </td>
                </tr>
                <tr>
                    <td><br>Date filed: <input type="text" size="20" style="border-top: 0px; border-left: 0px; border-right: 0px; text-align:center;" value="{{ data.date_filed }}"></td>
                    <td class="text-center"><br><br><strong><u contenteditable="true">{{ personnel_officer.key_acronym|upper }}</u></strong> <br>Personnel Officer</td>
                </tr>
                <tr>
                    <td><br>&emsp;&emsp;&emsp; The Undersigned MOA Worker respectfully requests for compensatory time/day off on: <br>

                        <center>
                        <u>
                        <strong>
                        {% if data.start_date is None %}
                            {% get_ctdo_dates data.id %}
                        {% else %}
                            {% if data.start_date == data.end_date %}
                                {{ data.start_date|date:"F d, Y" }}
                            {% else %}
                                {{ data.start_date|date:"F d, Y" }} - {{ data.end_date|date:"F d, Y" }}
                            {% endif %}
                        {% endif %}
                        </strong>
                        </u>
                        </center>
                    </td>
                    <td class="text-center">
                        <br>
                        <strong>Recommended by:</strong>
                        <br><br><br>
                        {% getemployeebyempid first_level as first_lvl %}
                        <u contenteditable="true"><strong>{{ first_lvl.pi.user.get_fullname|upper }}</strong></u>
                        <br>Division Chief / Supervisor
                    </td>
                </tr>
                <tr>
                    <td class="text-center">
                        <br><br><br>
                        <u><strong>{{ data.emp.pi.user.get_fullname|upper }}</strong></u> <br>
                        Name and Signature of MOA Worker
                    </td>
                    <td class="text-center">
                        <br>
                        <strong>Approved by:</strong>
                        <br><br><br>
                        {% getemployeebyempid second_level as second_lvl %}
                        <u><h4 class="no-margins" contenteditable="true"><strong>RAMIL M. TACULOD</strong></h4></u>
                        <h5 class="no-margins" contenteditable="true">Chief Admin Officer</h5>
                    </td>
                </tr>
            </table>
            <br>
            {% get_color_coding data.emp_id as color_coding %}
            {% if color_coding %}
            <br><br>
            <p><i class="fas fa-square" style="color: {{ color_coding }} !important;"></i> {{ color_coding|upper }}</p>
            {% endif %}
            <hr style="border-top: 2px dashed black;">
            <center>
                <p><strong>CHECKLIST REQUIREMENTS</strong></p>
                <img src="{% static 'image/leave_application/ctdo requirements.png' %}" width="70%">
            </center>
        </div>
    </page>

    <script src="{% static 'js/jquery-3.1.1.min.js' %}"></script>
	<script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/plugins/sweetalert/sweetalert.min.js' %}"></script>
    <script src="{% static 'js/functions.js' %}"></script>
    <script>
        $(document).ready(function(){
            window.onafterprint = function() {
                $.ajax({
                    url: '{% url "ctdo_after_print" %}',
                    data: {
                        'pk': {{ data.id }}
                    },
                    type: "POST",
                });
            }

            '{% if not data.remarks %}'
            function convertToMinutes(days, hours, minutes) {
                return days * 8 * 60 + hours * 60 + minutes;
            }

            function convertToDaysHoursMinutes(minutes) {
                var days = Math.floor(minutes / (8 * 60));
                minutes -= days * 8 * 60;
                var hours = Math.floor(minutes / 60);
                minutes -= hours * 60;
                return [days, hours, minutes];
            }

            var totalInMinutes = convertToMinutes(parseInt('{% if history.total_days %}{{ history.total_days }}{% else %}0{% endif %}'),
                                                parseInt('{% if history.total_hours %}{{ history.total_hours }}{% else %}0{% endif %}'),
                                                parseInt('{% if history.total_minutes %}{{ history.total_minutes }}{% else %}0{% endif %}'));
            var inputInMinutes = convertToMinutes(parseInt('{% if history.total_u_days %}{{ history.total_u_days }}{% else %}0{% endif %}'),
                                                parseInt('{% if history.total_u_hours %}{{ history.total_u_hours }}{% else %}0{% endif %}'),
                                                parseInt('{% if history.total_u_minutes %}{{ history.total_u_minutes }}{% else %}0{% endif %}'));
            var remainingInMinutes = inputInMinutes - totalInMinutes;

            var remainingBalance = convertToDaysHoursMinutes(remainingInMinutes).map(function(value) {
                return isNaN(value) ? 0 : value;
            });;

            var text_remarks = `Outstanding COC Balance for Payroll Deduction: ${remainingBalance[0]} days, ${remainingBalance[1]} hours, ${remainingBalance[2]} minutes`;

            if(text_remarks != 'Outstanding COC Balance for Payroll Deduction: 0 days, 0 hours, 0 minutes' && remainingBalance[0] > 0) {
                $('#table-ctdo').append(
                    `
                    <tfoot>
                        <tr>
                            <td colspan="4">Note: Outstanding COC Balance for Payroll Deduction: ${remainingBalance[0]} days, ${remainingBalance[1]} hours, ${remainingBalance[2]} minutes</td>
                        </tr>
                    </tfoot>
                    `
                );

                $.post({
                    url: '{% url "ctdo_add_remarks" %}',
                    data: {
                        pk: '{{ data.id }}',
                        remarks: text_remarks,
                    },
                    success: function(response) {
                        if(response.data == "success"){
                            window.location.href = "/personnel/requests/ctdo/print/{{ data.id }}";
                        }
                    }
                })
            }
            '{% endif %}'
        });
    </script>
</body>
</html>